name: Checkmarx Vorpal SAST Scan

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly scan on Monday at 2 AM
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  vorpal-sast-scan:
    name: Vorpal SAST Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis
    
    - name: Checkmarx Vorpal SAST Scan
      uses: checkmarx/ast-github-action@main
      with:
        # Authentication
        base_uri: https://ast.checkmarx.net
        cx_tenant: ${{ secrets.CHECKMARX_TENANT }}
        cx_client_id: ${{ secrets.CHECKMARX_CLIENT_ID }}
        cx_client_secret: ${{ secrets.CHECKMARX_CLIENT_SECRET }}
        
        # Project configuration
        project_name: NodeGoat
        branch: ${{ github.ref_name }}
        
        # Scan type - SAST only (Vorpal)
        scan_types: sast
        
        # Results configuration
        output_name: vorpal-results
        report_format: sarif,json,pdf
        
        # Thresholds
        break_build: false
        sast_high: 10
        sast_medium: 50
        sast_low: 100
        
        # Additional SAST parameters
        additional_params: |
          --sast-incremental
          --debug
    
    - name: Upload SARIF to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: vorpal-results.sarif
        category: checkmarx-vorpal-sast
    
    - name: Upload Scan Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: vorpal-scan-reports
        path: |
          vorpal-results.sarif
          vorpal-results.pdf
          vorpal-results.json
        retention-days: 30
    
    - name: Generate Scan Summary
      if: always()
      run: |
        echo "## ðŸ” Checkmarx Vorpal SAST Scan Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** NodeGoat" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Scan Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š View detailed results in the **Security** tab â†’ **Code scanning**" >> $GITHUB_STEP_SUMMARY
